<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title data-i18n="page_title_farmer">AgroMatch - Dashboard Agricultor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <link rel="stylesheet" href="../assent/css/index-agricultor.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Overlay para cerrar dropdown -->
    <div class="overlay" id="overlay"></div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <img src="../assent/img/logo-Agro.png" alt="AgroMatch Logo" style="height:40px;">
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.location.href='buscar-trabajadores.html'">
                    <i class="fas fa-users"></i> <span data-i18n="search_workers">Buscar Trabajadores</span>
                </button>
                <button class="btn btn-primary" onclick="createNewOffer()">
                    <i class="fas fa-plus"></i> <span data-i18n="new_offer">Nueva Oferta</span>
                </button>
                <div class="notification-icon" onclick="showNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </div>
                
                <div class="user-menu-container">
                    <button class="profile-menu" onclick="toggleProfileMenu()" id="profileMenuBtn">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="main-panel">
                <button class="create-offer-btn" onclick="createNewOffer()">
                    <i class="fas fa-plus"></i> <span data-i18n="create_new_offer">Crear Nueva Oferta de Trabajo</span>
                </button>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="ofertasActivas">0</div>
                            <div class="stat-label" data-i18n="active_offers">Ofertas Activas</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number" id="trabajadoresContratados">0</div>
                            <div class="stat-label" data-i18n="hired_workers">Trabajadores Contratados</div>
                        </div>
                    </div>
                </div>

                <!-- Contenedor de ofertas -->
                <div id="ofertasContainer" class="ofertas-container"></div>
                
                <!-- Paginación -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <button class="pagination-btn" id="prevPageBtn" onclick="cambiarPaginaOfertas('prev')" disabled>
                        <i class="fas fa-chevron-left"></i>
                        <span>Anterior</span>
                    </button>
                    <div class="pagination-info">
                        <span>Página <strong id="currentPageNum">1</strong> de <strong id="totalPagesNum">1</strong></span>
                    </div>
                    <button class="pagination-btn" id="nextPageBtn" onclick="cambiarPaginaOfertas('next')">
                        <span>Siguiente</span>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="side-panel">
                <!-- Perfil del Agricultor -->
                <div class="profile-card">
                    <div class="profile-avatar-large" id="sidebarProfileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 class="profile-name" id="sidebarProfileName">Cargando...</h3>
                    <div class="profile-role">
                        <i class="fas fa-seedling"></i>
                        <span>Agricultor</span>
                    </div>
                    <div class="profile-rating" id="sidebarRating">
                        <i class="far fa-star"></i>
                        <i class="far fa-star"></i>
                        <i class="far fa-star"></i>
                        <i class="far fa-star"></i>
                        <i class="far fa-star"></i>
                        <span class="rating-value">0.0</span>
                    </div>
                </div>
                
                <div class="section-title">
                    <i class="fas fa-map-marked-alt"></i>
                    <span data-i18n="location_map">Mapa de Ubicación</span>
                </div>
                <div id="map" style="height: 300px; border-radius: 15px; overflow: hidden; border: 2px solid #4a7c59; margin-bottom: 20px;"></div>

                <div class="notifications">
                    <div class="section-title">
                        <i class="fas fa-bell"></i>
                        <span data-i18n="recent_notifications">Notificaciones Recientes</span>
                    </div>
                    
                    <div class="notification-item" onclick="handleNotification(this)">
                        <div class="notification-icon-wrapper">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title" data-i18n="new_applications">Nuevas postulaciones</div>
                            <div class="notification-text" data-i18n="new_applications_text">Tienes 2 trabajadores interesados</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CREAR NUEVA OFERTA -->
    <div class="modal-overlay" id="modalCrearOferta">
        <div class="modal-crear-oferta">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    <span data-i18n="create_new_offer">Crear Nueva Oferta</span>
                </h2>
                <button class="modal-close" onclick="cerrarModalOferta()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="formCrearOferta" onsubmit="crearOferta(event)">
                    <div class="form-group">
                        <label for="tituloOferta" class="form-label">
                            <i class="fas fa-tag"></i>
                            <span data-i18n="offer_title">Título de la Oferta</span>
                        </label>
                        <input 
                            type="text" 
                            id="tituloOferta" 
                            name="titulo"
                            class="form-input" 
                            data-i18n-placeholder="offer_title_example"
                            placeholder="Ej: Cosecha de Café - Finca El Paraíso"
                            required
                            maxlength="200">
                    </div>

                    <div class="form-group">
                        <label for="descripcionOferta" class="form-label">
                            <i class="fas fa-align-left"></i>
                            <span data-i18n="job_description">Descripción del Trabajo</span>
                        </label>
                        <textarea 
                            id="descripcionOferta" 
                            name="descripcion"
                            class="form-textarea" 
                            data-i18n-placeholder="job_description_placeholder"
                            placeholder="Describe detalladamente el trabajo a realizar, requisitos, horarios, ubicación, etc."
                            required
                            maxlength="1000"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="pagoOferta" class="form-label">
                            <i class="fas fa-dollar-sign"></i>
                            <span data-i18n="offered_pay">Pago Ofrecido (COP por día)</span>
                        </label>
                        <input 
                            type="number" 
                            id="pagoOferta" 
                            name="pago"
                            class="form-input" 
                            placeholder="50000"
                            required
                            min="10000"
                            step="1000">
                    </div>

                    <div class="form-group">
                        <label for="ubicacionOferta" class="form-label">
                            <i class="fas fa-map-marker-alt"></i>
                            <span data-i18n="job_location">Ubicación del Trabajo</span>
                        </label>
                        <input 
                            type="text" 
                            id="ubicacionOferta" 
                            name="ubicacion"
                            class="form-input" 
                            data-i18n-placeholder="location_example"
                            placeholder="Ej: Vereda El Paraíso, Chinchiná, Caldas"
                            required
                            maxlength="255">
                    </div>
                </form>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancelar" onclick="cerrarModalOferta()">
                    <i class="fas fa-times"></i>
                    <span data-i18n="cancel">Cancelar</span>
                </button>
                <button type="submit" form="formCrearOferta" class="btn-modal btn-crear" id="btnCrearOferta">
                    <i class="fas fa-check"></i>
                    <span data-i18n="create_offer">Crear Oferta</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR OFERTA -->
    <div class="modal-overlay" id="modalEditarOferta">
        <div class="modal-crear-oferta">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-edit"></i>
                    <span data-i18n="edit_offer">Editar Oferta</span>
                </h2>
                <button class="modal-close" onclick="cerrarModalEditar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="formEditarOferta" onsubmit="guardarEdicion(event)">
                    <input type="hidden" id="editOfertaId" name="ofertaId">
                    
                    <div class="form-group">
                        <label for="editTituloOferta" class="form-label">
                            <i class="fas fa-tag"></i>
                            <span data-i18n="offer_title">Título de la Oferta</span>
                        </label>
                        <input 
                            type="text" 
                            id="editTituloOferta" 
                            name="titulo"
                            class="form-input" 
                            required
                            maxlength="200">
                    </div>

                    <div class="form-group">
                        <label for="editDescripcionOferta" class="form-label">
                            <i class="fas fa-align-left"></i>
                            <span data-i18n="job_description">Descripción del Trabajo</span>
                        </label>
                        <textarea 
                            id="editDescripcionOferta" 
                            name="descripcion"
                            class="form-textarea" 
                            required
                            maxlength="1000"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editPagoOferta" class="form-label">
                            <i class="fas fa-dollar-sign"></i>
                            <span data-i18n="offered_pay">Pago Ofrecido (COP por día)</span>
                        </label>
                        <input 
                            type="number" 
                            id="editPagoOferta" 
                            name="pago"
                            class="form-input" 
                            required
                            min="10000"
                            step="1000">
                    </div>

                    <div class="form-group">
                        <label for="editUbicacionOferta" class="form-label">
                            <i class="fas fa-map-marker-alt"></i>
                            <span data-i18n="job_location">Ubicación del Trabajo</span>
                        </label>
                        <input 
                            type="text" 
                            id="editUbicacionOferta" 
                            name="ubicacion"
                            class="form-input" 
                            required
                            maxlength="255">
                    </div>
                </form>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancelar" onclick="cerrarModalEditar()">
                    <i class="fas fa-times"></i>
                    <span data-i18n="cancel">Cancelar</span>
                </button>
                <button type="submit" form="formEditarOferta" class="btn-modal btn-crear" id="btnGuardarEdicion">
                    <i class="fas fa-save"></i>
                    <span data-i18n="save_changes">Guardar Cambios</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODALES DE POSTULACIONES -->
    <div class="modal" id="applicationsModal" style="display: none;">
        <div class="modal-content applications-modal">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> <span data-i18n="applications">Postulaciones</span></h2>
                <button class="close-btn" onclick="closeApplicationsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="applicationsContent"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="workerProfileModal" style="display: none;">
        <div class="modal-content worker-profile-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> <span data-i18n="worker_profile">Perfil del Trabajador</span></h2>
                <button class="close-btn" onclick="closeWorkerProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="workerProfileContent"></div>
            </div>
        </div>
    </div>

    <script src="../js/language-manager.js"></script>
    <script src="../js/index-agricultor.js"></script>
    
    <!-- Script de paginación -->
    <script>
        // Variables de paginación para ofertas
        let ofertasPaginaActual = 1;
        const ofertasPorPagina = 3;
        let todasLasOfertas = [];

        // Función para cambiar de página
        window.cambiarPaginaOfertas = function(direccion) {
            const totalPaginas = Math.ceil(todasLasOfertas.length / ofertasPorPagina);
            
            if (direccion === 'prev' && ofertasPaginaActual > 1) {
                ofertasPaginaActual--;
            } else if (direccion === 'next' && ofertasPaginaActual < totalPaginas) {
                ofertasPaginaActual++;
            }
            
            mostrarOfertasPaginadas();
        };

        // Sobrescribir mostrarOfertasEnDashboard para usar paginación
        const originalMostrarOfertas = window.mostrarOfertasEnDashboard;
        window.mostrarOfertasEnDashboard = function(ofertas) {
            todasLasOfertas = ofertas;
            ofertasPaginaActual = 1;
            
            if (ofertas.length === 0) {
                // Llamar a la función original si no hay ofertas
                if (originalMostrarOfertas) {
                    originalMostrarOfertas(ofertas);
                }
                const paginationContainer = document.getElementById('paginationContainer');
                if (paginationContainer) paginationContainer.style.display = 'none';
                return;
            }
            
            mostrarOfertasPaginadas();
        };

        function mostrarOfertasPaginadas() {
            const container = document.getElementById('ofertasContainer');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (!container) return;
            
            const inicio = (ofertasPaginaActual - 1) * ofertasPorPagina;
            const fin = inicio + ofertasPorPagina;
            const ofertasPagina = todasLasOfertas.slice(inicio, fin);
            
            container.innerHTML = `
                <div class="section-title" style="margin: 30px 0 20px 0;">
                    <i class="fas fa-clipboard-list"></i>
                    Mis Ofertas Publicadas (${todasLasOfertas.length})
                </div>
            `;
            
            ofertasPagina.forEach(oferta => {
                const ofertaCard = crearTarjetaOferta(oferta);
                container.appendChild(ofertaCard);
            });
            
            // Actualizar paginación
            const totalPaginas = Math.ceil(todasLasOfertas.length / ofertasPorPagina);
            
            if (totalPaginas > 1) {
                paginationContainer.style.display = 'flex';
                document.getElementById('currentPageNum').textContent = ofertasPaginaActual;
                document.getElementById('totalPagesNum').textContent = totalPaginas;
                
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');
                
                prevBtn.disabled = ofertasPaginaActual === 1;
                nextBtn.disabled = ofertasPaginaActual === totalPaginas;
            } else {
                paginationContainer.style.display = 'none';
            }
        }
    </script>
</body>
</html>